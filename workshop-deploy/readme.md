# Деплой приложения

После того, как приложение или страница готовы, их чаще всего необходимо разместить в сети (на сервере который имеет публичный IP-адрес) или просто на автономном компьютере который постоянно подключен к сети.

Чтобы любой пользователь мог обратиться к вашему сайту (серверу, на котором работает наша программа) у этого сервера должен быть постоянный и глобальный адрес. Доменное имя, (например example.com) это только указатель на IP-адрес сервера. Домашние и рабочие сети чаще всего не имеют постоянных адресов, из-за их дифицита. Даже если ваша сеть имеет статичный IP адрес, то ваш компьютер, подключенный к ней, находится за NAT (Network address translation) – это значит, что глобальный адрес всего один на всю сеть и он присваивается входной точке вашей сети (роутеру), и следовательно ваш компьютер имеет только локальный адрес (например 192.168.1.2). Поэтому компьютеры, подключенные к глобальной сети не могут напрямую подключится к вашему компьютеру или серверу установленному у вас дома.

Существует несколько способов как разместить программу в глобальной сети (получить глобальный/публичный IP-адрес):

1. Для того, чтобы код вашей программы выполнялся на вашем компьютере, но был доступен в интернете, можно использовать технологию, называемую __обратный туннель__. Это может быть специальный сервис или ваш собственный виртуальный сервер, работающий в качестве 'прокси'. Этот сервер, имеющий глобальный IP-адрес может отправлять запросы к вашему компьютеру, используя _обратный туннель_ – безопасное соединение с вашим компьютером, инициированное вашим компьютером.
2. Для статичных страниц можно использовать __хостинг статичных файлов__ (static files hosting). Например: [github pages](https://pages.github.com/), список сервисов: [cheap or free static website hosting](http://alignedleft.com/resources/cheap-web-hosting).
3. Код выполняемый на сервере, код чат-бота или динамически формируемую страницу можно разместить используя __сервер__ (dedicated server) или __виртуальный сервер__ (VPS). В этом случае, вы чаще всего платите за аренду физической или виртуальной машины, на которой можете делать все что угодно: устанавливать программы которые вам нужны и выполнять любой код. Пример популярного сервиса для аренды VPS-серверов: [digitalocean](http://digitalocean.com).


### 1. Обратный туннель

Вариант, наименее распростанненный, но наиболее подходящий для художественных проектов, когда к работающему устройству в помещении необходим доступ из глобальной сети. Пример такого сервиса, бесплатно предоставляющего ssh-туннели на рандомные субдомены является [ngrok.com](https://ngrok.com). Чтобы воспользоваться этим сервисом необходимо:

1. Загрузить программу [ngrok](https://ngrok.com/download)
2. Разархивировать загруженный файл
3. Запустить программу из терминала, указав путь к только что разархивированному файлу, например: `~/Downloads/ngrok http 8000` (данной командой мы запускаем туннель на 8000 порту)
4. В командной строке у вас должен отобразиться адрес домена, по которому теперь доступен ваш 8000 порт. Например:
    ```
    Forwarding  https://9c36621d.ngrok.io -> localhost:8000
    ```

Теперь, любой подключившийся по этому адресу увидит вашу программу запущенную на этом порту. Полноценный пример приложения для тестирования обратного туннеля, который произносит введенную пользователем фразу на странице: [example-say-input](../workshop-simple-interface/example-say-input).


### 2. Хостинг статичных файлов

Мы попробуем задеплоить сайт используя бесплатный сервис pages.github.com. Другие варианты деплоя статичных файлов могут сильно отличаться от этого, но менее практичны и требуют оплаты. Инструкция ниже позволяет создать сайт по адресу username.github.io. Возможно также привязать свой собственный домен к этому же сайту, также бесплатно.

1. Создать аккаунт на [github.com](https://github.com)
2. Скачать и установить [github desktop](https://desktop.github.com/)
3. Запустить программу, войти в нее под своим аккаунтом
4. Создать новый репозиторий в программе, название которого __должно быть__ `username.github.io`, где `username` это ваше имя пользователя, которое вы указали при регистрации
5. Поместить в папку репозитория все необходимые файлы сайта (например внутренности папки, которая получилась при экспорте из Unity). Таким образом, чтобы в корне репозитория, обязательно оказался файл `index.html`
6. Совершить `commit` – сохранить текущий статус файлов в папке репозитория, предварительно дав ему название (Поле `Summary`)
7. Синхронизировать изменения с github (Большая кнопка `Publish`)
8. Открыть в браузере ваше имя репозитория: `username.github.io`

> Для того, чтобы загрузить новую версию игры, нужно удалить старые файлы игры (но не всю папку репозитория), снова произвести `commit` в интерфейсе программы _github desktop_ и загрузить (синхронизировать эти изменения на гитхаб)


### 3. Виртуальный сервер

Для того, чтобы выполнять код программы в интернете, можно арендовать виртуальный ресурс в датацентре. Аренда виртуальной машины с одним процессором, 512Mb оперативной памяти и 20Gb жесткого диска стоит около $5 в месяц, и этих ресурсов будет достаточно, чтобы выполнять код бота. Мы будем использовать сервис DigitalOcean, но почти весь процесс будет идентичен для других сервисов.

1. __Регистрация и покупка__. Этот пункт мы опускаем, потому что мы все можем использовать одну и ту же машину, которая зарегистрирована для всех. В случае, если вы будете покупать сервер самостоятельно, имеет значение только операционная система (мы будем использовать Ubuntu 16.04). В конце покупки вы получите адрес и пароль от машины, которую вы только что создали.
2. __Подключение по SSH__
    - Пользователи Unix могут просто открыть терминал. Пользователям Windows придется использовать программу, которая называется __putty__
    - Пользователи Unix вводят в терминал команду `ssh root@server.ip.address.number`, где `server.ip.address.number` нужно заменить на адрес созданного сервера
    После выполнения этой команды вы оказываетесь в командной строке сервера, и можете выпонять те же команды, которые вы выполняли на своей машине (установка и выполнение программ), но теперь применительно к серверу.
3. __Установка программ__. В Ubuntu, для установки программ (например node или mqtt-брокера) существует пакетный менеджер `apt-get`. Например, для установки `nodejs` можно выполнить `apt-get install nodejs`
4. __Загрузка / cинхронизация кода__. Для того, чтобы поместить код вашей программы на сервер на Unix можно использовать программу `rsync`, которая сихронизирует одну папку с другой. Команда должна выглядить следующим образом:
   ```
   rsync -av path/to/folder/from/ root@server.ip.address.number:/root/projects/
   ```
   Другой возможностью загружать файлы на удаленный сервер является SFTP-программы (Secure File Transfer Protocol). Например [cyberduck](https://cyberduck.io/)
5. __Запуск__. Чтобы запустить программу, нужно выполнить те же команды, что мы выполняли на нашем компьютере: `cd` в папку проекта, `node app.js` и `npm install название-пакета` если какая-то из библиотек не установлена
6. __Запуск в виртуальном окне__. Чтобы программа продолжила работать после того, как вы отключитесь от сервера, ее можно запустить внутри виртуальной сессию. Для управления виртуальными сессиями можно использовать команды:
    - Команда `tmux new` - создаст сессию
    - Сочетание клавиш `Ctrl+B`, а затем `D` отключится от виртуальной сессии и вернется в обычную
    - Команда `tmux attach` - подключится к открытой виртуальной сессии


### 4. Raspberry Pi

В случае, если ваша программа не обязательно должна быть доступна в интернете по адресу (например не сайт, а чат-бот или просто бот), программу можно выполнять на машине, которая стоит например у вас дома и постоянно подключена к питанию и интернету. Для этого прекрасно подходят дешевые одноплатные компьютеры. Один из самых популярных – Raspberry Pi. Существует несколько версий – мы будем использовать _Raspberry Pi Zero W_ – самую последнюю модель со встроенным WiFi-модулем.

#### Операционная система

Для того, чтобы Raspberry заработал, ему нужна операционнаая система. Мы будем использовать операционную систему [Raspbian](https://www.raspberrypi.org/downloads/raspbian/) - вариант линукса, специально разработанный для этого компьютера и образовательных целей. Raspberry Pi использует SD-карту в качестве жесткого диска, поэтому опрационную систему можно записать прямо на карточку, вставить ее в компьютер и он заработает. Инструкции по записи скачанного образа с Raspbian на SD можно найти [здесь](https://www.raspberrypi.org/documentation/installation/installing-images/README.md).

#### Подключение к сети

После того, как операционная система записана на карточку, существует возможность сконфигурировать данные WiFi-подключения, чтобы при запуске Raspberry автоматически подключалась к интернету. Для этого,
1. Подключить карту с записанной Raspbian к компьютеру
2. Карта должна определится как диск с именем `Boot`. В этом разделе карты лежат только файлы конфигурации
3. В корне этого диска нужно создать текстовый файл с названием `wpa_supplicant.conf`, и параметрами вашей сети. Чаще всего нужно поменять только имя и пароль, не меняя третий параметр:
```
network={
  ssid="name_of_your_network"
  psk="password_of_your_network"
  key_mgmt=WPA-PSK
}
```
4. Также необходимо создать пустой файл с названием `SSH` и без расширения в корне диска `Boot` для того, чтобы активировать ssh-сервер
5. Подключить Raspberry к питанию через вход помеченный `PWR`
6. Подождать минуту и попробовать подключится к устройству в локальной сети, которое имеет домен `raspberrypi.local`, имя пользователя `pi` и пароль `raspberry`. В unix это будет одна команда:
```
ssh pi@raspberrypi.local
```
