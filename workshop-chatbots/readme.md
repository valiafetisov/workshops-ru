# Чат-боты, официальные и неофициальные API

Для начала, чтобы облегчить задачу обучения веб-программированию, которое строиться сразу на трех технологиях: html, css, js, мы попробуем написать программу, которая использует только одну часть из перечисленного: js. Для этого хорошо подходят чат-боты, которые являясь отдельной программой, используют интерфейс уже готового приложения. Будь то Telegram, Messenger или Slack. Мы начнем обучение использования официального API для [Telegram](https://telegram.org) и неофициального для [Facebook](https://messenger.com).

> #### Что такое API и как с ним работать
>
> API расшифровывается как _Application Programming Interface_, то есть некоторый интерфейс, но в отличие от графического (GUI) – программный, то есть предназначенный для того, чтобы одна программа могла общаться с другой. API можно разделить на две категории:
>  * __Официальные__ API – те, для которых написана документация, рассказано как ими пользоваться и написаны специальные SDK (от _Software Development Kit_) облегчающие работу разработчика
>  * __Неофициальные__ – незадокументированные API, которые в любой момент могут измениться и перестать работать и к которым чаще всего нет никаких SDK


#### Что получится в конце занятия

Чат-бот, который по присланному сообщению будет отвечать предзаданной фразой.


### Подзадачи

1. Зарегистрировать официального чат-бота в [`telegram.org`](https://telegram.org/)
2. Написать программу, которая подлючается к серверу телеграма и получает сообщения от пользователей
3. Добавить автоматический ответ на сообщение пользователя
4. Проделать то же самое с [неофициальным API](https://github.com/Schmavery/facebook-chat-api) Facebook Messenger


### 1. Регистрация официального чат-бота в телеграм

Необходимо иметь установленное приложение [telegram](https://telegram.org/), в котором нужно найти пользователя с ником `@botfather`, написать ему `/newbot`, ответить на его вопросы, и получить в конце ссылку на бота и токен – другими словами ключ (пароль) для управления нашим ботом.


### 2. Написание бота для Telegram

01. Cоздать новую папку для проекта и создать в ней файл app.js.

02. Установить пакет для работы с Telegram API.

    Для работы с Telegram нам понадобиться SDK или другими словами модуль или пакет (package) который будет содержать код для работы с API приема и отправки сообщений, а мы, в нашей программе, сможем использовать только абстрактные методы для отправки и приема сообщений.

    В терминале, находясь в папке проекта, выполняем команду `npm install node-telegram-bot-api --save`, которая установит пакет для работы с telegram api, который мы нашли в гугле набрав [telegram nodejs api](https://www.google.com/search?q=telegram+nodejs+api)

03. Добавить новый пакет в нашу программу:
      ```javascript
      var Telegram = require('node-telegram-bot-api')
      ```

04. Добавить в код программы переменную с ключем от созданного бота
      ```javascript
      // вместо HERE_IS_YOUR_TOKEN нужно вставить токен
      var token = 'HERE_IS_YOUR_TOKEN'
      ```

05. Инициализировать чат-бота
      ```javascript
      // с этого момента программа подключается к серверу telegram
      // и начнет принимать данные и ждать от нас других команд
      var bot = new Telegram(token, {polling: true})
      ```

06. Добавить логирование сообщений, присылаемых ботом:
      ```javascript
      // выражение, которое при получении сообщения выведет его в терминал для отладки
      bot.on('message', function(msg) {
      	console.log(msg)
      })
      ```

    > Все эти команды, взяты из документации используемого пакета найденного в официальном репозитории: [node-telegram-bot-api](https://github.com/yagop/node-telegram-bot-api)

07. После этого можно сохранить файл `app.js`, выполнить его (`node app.js`) и попробовать отправить своему боту сообщение в телеграме. После этого, буквально в течении секунды вы должны будете увидеть как в терминале, где запущено приложение появиться несколько новых строк. Примерно таких:
      ```javascript
      {
        message_id: 303,
        from: { id: 198431062, first_name: 'Valia' },
        chat: { id: 198431062, first_name: 'Valia', type: 'private' },
        date: 1463096618,
        text: 'test'
      }
      ```
    Это ничто иное как _объект_ сообщения, которое пришло нам от пользователя с именем 'Valia' и номером 198431062 в приватном чате с таким же номером. 1463096618 здесь – дата в unix-формате (количество секунд, прошедших с 1 января 1970 года)


### 3. Автоматический ответ на сообщения

Теперь мы можем вместо одной строчки `console.log(msg)` поместить код, который будет отвечать этому же пользователю

```javascript
bot.on('message', function(msg) {
  // console.log выводит в терминал перменную msg, для отладки
  console.log(msg)

  // формируем текст сообщения
  const reply = 'Отстань, ' + msg.from.first_name

  // отправляем текстовое сообщение
  // где msg.chat.id – это id чата (который мы берем из присланного нам объекта msg)
  bot.sendMessage(msg.chat.id, reply)
})
```

[Более широкий туториал по чат-боту для телеграма на русском языке](http://catethysis.ru/node-js-telegram-bot/)


### 4. Создание бота для Facebook Messenger

Facebook только год назад открыл возможность написания ботов. Но как и другие сервисы, боты обладают определенными особенностями и ограничениями. Например, человек пока не может официально иметь бота-помошника, ботом может выступать только страница. Чтобы обойти это ограничение и иметь возможность автоматически отвечать вашим друзьям, можно использовать неофициальное API. Для неофициального API фейсбука к счастью существует готовый пакет, который эмулирует работу браузера и отправляет сообщения почти как это делаете вы сами. Он называется [facebook-chat-api](https://github.com/Schmavery/facebook-chat-api)

01. Чтобы использовать этот пакет, нужно установить его в директорию с программой.
    Для этого, выполнить `npm install facebook-chat-api` в терминале

02. Добавить пакет в программу:
    ```javascript
    var login = require('facebook-chat-api')
    ```

03. Инициализировать бота и сразу добавить автоматический ответ
    ```javascript
    // вместо FB_EMAIL и FB_PASSWORD нужно ввести
    // свои реальные логин и пароль от фейсбука
    login({email: 'FB_EMAIL', password: 'FB_PASSWORD'}, function (err, api) {
      // это строка, при наличии ошибки логина, выведет ее в консоль
      if(err) return console.error(err)

      // эта функция вызовется при получении нового сообщения
      api.listen((err, message) => {
        console.log('message', message)
        // эта функция отправит обратно то же сообщение
        api.sendMessage(message.body, message.threadID)
      })
    })
    ```


### Домашнее задание

Изучить возможности обоих API и сделать чат-бота на основе одной из них.
