# Unity, WebGL, сокеты

Веб, став самой большой платформой, продолжает развиваться. С недавних пор браузеры добавили поддержку двух ключевых технологий. Первая называется _WebGL_ – это программный интерфейс к видеокарте из javascript, возможность рендерить сложную графику прямо в браузере, без каких-либо плагинов. Вторая технология называется _WebAssembly_ (а также _asm.js_) – низкоуровневый язык программирования, выполняющийся в браузере, используемый как промежуточный (результат компиляции другого языка). Другими словами, появилась возможность компилировать программы написанные на других языках (C/C++/C#) для выполнения их в современных браузерах без серьезной потери в производительности.


### WebGL и работа с 3D в браузере

Чтобы воспользоваться возможностями WebGL можно использовать библиотеки и фреймворки, упрощающие написание кода. Например [three.js](https://threejs.org/examples/) или [a-frame](https://aframe.io/). По ссылкам доступны примеры с исходным кодом.


### Unity

Unity – это игровой движок, с недавних пор поддерживающий компиляцию в WebGL (кроме обычного экспорта для mac, windows, android и ios). Вся разработка интерфейса / игры ведется внутри игровой платформы, которая затем экспортирует html-страницу и несколько скомпилированных файлов с кодом. Интерфейс программы очень похож на обычный 3D-редактор, подерживающий редактор сцены, материалов, анимации, но также написание своих собственных скриптов на языках C# или javascript. Единственный минус работы с компилированным кодом состоит в довольно больших размерах экспортируемой программы (страница может весить 20-50 Мб).

Пример комплексной игры, разработанной на Unity и скомпилированной в WebGL – [angrybots](http://beta.unity3d.com/jonas/AngryBots/), [исходный код проекта](https://github.com/tsugi/exampleunityangrybots). Пример использования движка не по назначению – сайт, по которому можно прогуляться [jjjjjj](http://jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj.jjaskowska.com), [исходный код](https://github.com/Jowska/personal-website). Пример художника, работающего с играми и физическим пространством [Theo Triantafyllidis](http://slimetech.org/), его работа [Self Portrait (Interior)](https://theotrian.itch.io/self-portrait-interior), доступна для загрузки. Из российских художников, работающих с этим направлением можно выделить Диму Кавко (к сожалению [мало](http://coub.com/view/2jmdg9o) документации в сети), [Мишу Максимова](https://vimeo.com/74753420), [Виолет Постнову](https://vimeo.com/148598531) и [Sara Culmann](https://vimeo.com/189937651).


#### Cоздание персонажа

Прежде всего, игровой движок позволяет создать персонажа, который впоследствие будет передвигаться по сцене. Существует несколько стандартных механик персонажей: __first person view__, __third person view__ или __cctv view__. Вы конечно всегда можете придумать [свой собственный](http://www.davidoreilly.com/everything/). Но мы попробуем рассмотреть вид от первого лица (FPV). Для этого нужно:

1. Импортировать скрипты персонажа из стандартных плагинов __Assets > Import Package > Characters__
2. В иерархизированном просмотре файлов проекта (в дальнейшем будем называть __вкладка project__) перейти в __Standard Assets > Characters > FirstPersonCharacter > Prefabs__
3. В этой папке выбрать и перетащить в сцену __FPSController__
4. Создать в сцене пол, на котором сможет стоять персонаж (кликнув правой кнопкой в пустом месте и выбрав __3D Object > Terrain__) иначе скрипт гравитации, применяемый к этому персонажу, унесет его вниз
5. Запустить приложение

Теперь можно выбрать один из элементов сцены и посмотреть какие параметры можно поменять в инспекторе.

> Изменения внесенные во время работы программы, в реальном времени применяются к сцене. Но после остановки игры отменяются, возвращаясь к изначальным параметрам. Это удобно для проверки параметров перед их примененем.

Кроме доступных параметров в полях инспектора, важно понимать, что все что называется скриптом в инспекторе, можно отредактировать и в виде кода, полностью поменяв логику его работы. Можно также писать свои собственные игрвые скрипты и привязывать их к игрвым объектам сцены.


#### Иморт готовых моделей

Unity поддерживает импорт готовых 3D моделей в различный форматах, в том числе и sketchup. Это удобно, так как для этой программы существует огромное количество бесплатных моделей на сайте [3D Warehouse](https://3dwarehouse.sketchup.com/?hl=en). Для импорта в Unity подходит версия файла 2015 года. Поэтому нужно либо скачать ее сразу с сайта (после нажатия кнопки Download на странице модели, откроется список доступных версий файла), либо вам придется устоновить программу скетчап, чтобы перевести нужный файл в этот формат. Краткая инструкция импорта модели:

1. Скачать файл модели версии `SketchUp 2015 Model`
2. В папке Unity-проекта найти папку `Assets`, создать в ней папку `Models` и положить туда скачанный файл
3. Перейти в Unity-редактор, должен появится статус ипорта. После окончания импорта, нужно найти модель во вкладке __project__, нажать на модель и в испекторе увидеть параметры модели
5. Дополнительно к выделенным параметрам импорта можно выделить галочкой `Generate Colliders` (для того чтобы импортируемая модель имела _физические_ границы) и нажать `Apply`
6. После повторного импорта модели, можно перетащить модель из _проекта_ в _сцену_

> Возможно, что выбранная модель слишком большая или слишком маленькая для сцены. Чтобы это исправить, можно реимпортировать ее изменив параметр __Unit conversion__.


#### Экспорт в WebGL, HTML-шаблон

1. __File > Build Settings...__
2. Нажать на кнопку __Add open scenes__, чтобы добавить открытую сцену в компилируемый проект
3. Из списка __platform__ выбрать __WebGL__
4. Нажать __Build__, ждать когда закончится процесс компиляции (3-10 минут на современном компьютере, в зависимости от размера проекта)

Так как некоторые браузеры не разрашают запускать локальные WebGL скрипты, то для корректного отображения html-файла может понадобится запустить локальный сервер. Например, можно использовать пакет `live-server` установив его глобально в систему (с флагом `-g`): `npm install live-server -g` (написав это в командной строке). Затем, находясь в папке с экспортированным файлом (в командной строке), можно выполнить команду `live-server`, которая запустит локальный сервер и откроет страницу с ним в браузере.

Чтобы сменить стандартный шаблон (рамку вокруг WebGL контента) можно просто отредактировать экспортированный html-файл или его css-зависимости. Но тогда при следующем экспорте, эту операцию нужно будет проделать еще раз. Вместо этого, Unity предоставляет возможность создать _template_, в который будет экспортироваться приложение. Можно использовать [готовый полноэкранный шаблон](./fullscreenTemplate), который я нашел и немного модифицировал. Для этого:

1. Нужно загрузить шаблон `fullscreenTemplate`
2. Поместить его в папку __Assets > WebGLTemplates__ (финальный адрес получится `ProjectName/Assets/WebGLTemplates/fullscreenTemplate/index.html`)
3. Выбрать его в настройках компиляции __Edit > Project Settings > Player__
4. Экспортировать приложение еще раз
